<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scatter Tooltip Lab - OfferIQ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --font-family: "Open Sans", sans-serif;
      --bg: #f5f7fb;
      --panel-bg: #ffffff;
      --text: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --accent-orange: #ff8c1a;
      --primary-blue: #2f61d5;
      --shadow-md: 0 8px 24px rgba(15, 23, 42, 0.1);
      --shadow-lg: 0 12px 32px rgba(15, 23, 42, 0.18);

      /* Tooltip Variables (Ajustables) */
      --tip-font-size: 28px;
      --tip-padding-y: 14px;
      --tip-padding-x: 18px;
      --tip-min-width: 140px;
      --tip-circle-size: 64px;
      --tip-dot-size: 20px;
      --tip-arrow-height: 8px;
      --tip-arrow-width: 10px;
      --tip-offset-x: 18px;
      --tip-circle-offset: -52px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg);
      color: var(--text);
    }

    .page {
      max-width: 1300px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 20px;
    }

    header {
      grid-column: 1 / -1;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    header h1 { font-size: 24px; margin: 0; }
    header p { color: var(--text-muted); margin: 5px 0 0; }

    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-md);
    }

    .controls h2, .preview h2, .code h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-top: 0;
      margin-bottom: 20px;
    }

    .control-group {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }

    .control {
      display: grid;
      gap: 5px;
    }

    .control label {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
    }

    .control label span { color: var(--primary-blue); }

    input[type="range"] { width: 100%; cursor: pointer; }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .preview { position: relative; }

    /* Estilos exactos del scatter chart del proyecto principal */
    .scatter-chart-container {
      position: relative;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      border: 1px solid var(--border);
    }

    .scatter-chart-container svg {
      width: 100%;
      height: 400px;
      display: block;
    }

    .scatter-grid line {
      stroke: rgba(17, 24, 39, 0.08);
      shape-rendering: crispEdges;
    }

    .scatter-axis path, .scatter-axis line {
      stroke: rgba(17, 24, 39, 0.25);
      shape-rendering: crispEdges;
    }

    .scatter-axis text {
      fill: var(--text-muted);
      font-size: 12px;
    }

    .scatter-point {
      fill: var(--accent-orange);
      opacity: 0.95;
      cursor: pointer;
    }

    .scatter-threshold {
      stroke: var(--primary-blue);
      stroke-width: 3;
      stroke-dasharray: 8 8;
    }

    .scatter-threshold-label {
      font-size: 12px;
      fill: var(--primary-blue);
      font-weight: 700;
    }

    /* TOOLTIP/BURBUJA (Ajustable con variables CSS) */
    .scatter-tip {
      position: absolute;
      pointer-events: none;
      opacity: 1; /* Siempre visible para el lab */
      transform: translateY(-50%);
      z-index: 10;
      transition: all 0.1s ease;
    }

    .scatter-tip.flip-left {
      transform: translate(-100%, -50%);
    }

    .scatter-tip-inner {
      position: relative;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(0, 0, 0, 0.06);
      font-size: var(--tip-font-size);
      font-weight: 800;
      color: #374151;
      padding: var(--tip-padding-y) var(--tip-padding-x);
      min-width: var(--tip-min-width);
      text-align: center;
      line-height: 1;
    }

    .scatter-tip-inner::before {
      content: "";
      position: absolute;
      left: calc(var(--tip-arrow-width) * -1);
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-top: var(--tip-arrow-height) solid transparent;
      border-bottom: var(--tip-arrow-height) solid transparent;
      border-right: var(--tip-arrow-width) solid #ffffff;
      filter: drop-shadow(-2px 2px 1px rgba(0, 0, 0, 0.08));
    }

    .scatter-tip.flip-left .scatter-tip-inner::before {
      left: auto;
      right: calc(var(--tip-arrow-width) * -1);
      border-right: none;
      border-left: var(--tip-arrow-width) solid #ffffff;
      filter: drop-shadow(2px 2px 1px rgba(0, 0, 0, 0.08));
    }

    .scatter-tip-dot {
      position: absolute;
      left: var(--tip-circle-offset);
      top: 50%;
      transform: translateY(-50%);
      background: #ffffff;
      border-radius: 50%;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(0, 0, 0, 0.06);
      width: var(--tip-circle-size);
      height: var(--tip-circle-size);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scatter-tip.flip-left .scatter-tip-dot {
      left: auto;
      right: var(--tip-circle-offset);
    }

    .scatter-tip-dot::after {
      content: "";
      border-radius: 50%;
      background: var(--accent-orange);
      width: var(--tip-dot-size);
      height: var(--tip-dot-size);
    }

    .code { grid-column: 1 / -1; }
    .code pre {
      background: #1e293b;
      color: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      overflow: auto;
      max-height: 500px;
      font-size: 13px;
    }

    .copy-btn {
      background: var(--primary-blue);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .copy-btn:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>OfferIQ Tooltip Lab</h1>
      <p>Personaliza el scatter y el tooltip para obtener el estilo visual deseado.</p>
    </header>

    <aside class="panel controls">
      <h2>Controles</h2>

      <div class="control-group">
        <div class="control">
          <label>Texto Tooltip <span id="val-text">4680</span></label>
          <input type="text" id="in-text" value="4680" />
        </div>

        <div class="control">
          <label>Tamaño Fuente <span id="val-font">28px</span></label>
          <input type="range" id="in-font" min="12" max="60" value="28" />
        </div>

        <div class="control">
          <label>Padding Y (Arriba/Abajo) <span id="val-pad-y">14px</span></label>
          <input type="range" id="in-pad-y" min="0" max="40" value="14" />
        </div>

        <div class="control">
          <label>Padding X (Lados) <span id="val-pad-x">18px</span></label>
          <input type="range" id="in-pad-x" min="0" max="50" value="18" />
        </div>

        <div class="control">
          <label>Ancho Mínimo <span id="val-min-w">140px</span></label>
          <input type="range" id="in-min-w" min="50" max="300" value="140" />
        </div>

        <div class="control">
          <label>Círculo Blanco <span id="val-circle">64px</span></label>
          <input type="range" id="in-circle" min="20" max="120" value="64" />
        </div>

        <div class="control">
          <label>Punto Naranja <span id="val-dot">20px</span></label>
          <input type="range" id="in-dot" min="5" max="60" value="20" />
        </div>

        <div class="control">
          <label>Offset X Burbuja <span id="val-offset-x">18px</span></label>
          <input type="range" id="in-offset-x" min="0" max="100" value="18" />
        </div>

        <div class="control">
          <label>Offset Círculo <span id="val-circle-off">-52px</span></label>
          <input type="range" id="in-circle-off" min="-150" max="0" value="-52" />
        </div>

        <div class="control">
          <label>Flecha Alto/Ancho <span id="val-arrow">8/10</span></label>
          <div style="display:flex; gap:10px;">
            <input type="range" id="in-arrow-h" min="0" max="30" value="8" />
            <input type="range" id="in-arrow-w" min="0" max="30" value="10" />
          </div>
        </div>

        <div class="control">
          <label>Radio Punto Scatter <span id="val-p-radius">6px</span></label>
          <input type="range" id="in-p-radius" min="1" max="15" value="6" />
        </div>
      </div>
    </aside>

    <main class="panel preview">
      <h2>Preview</h2>
      <div class="scatter-chart-container" id="scatter-container">
        <svg id="scatter-svg"></svg>
        <div class="scatter-tip" id="scatter-tip">
          <div class="scatter-tip-dot"></div>
          <div class="scatter-tip-inner" id="tip-text-el">4680</div>
        </div>
      </div>
    </main>

    <section class="panel code">
      <h2>Código Generado (CSS)</h2>
      <button class="copy-btn" id="copy-css">Copiar CSS</button>
      <pre><code id="code-css"></code></pre>
    </section>
  </div>

  <script>
    // Configuración base similar al proyecto original
    const config = {
      n: 40,
      xDomain: [-6, 7],
      yDomain: [-2, 2],
      thresholdY: -0.4,
      margin: { top: 20, right: 30, bottom: 40, left: 50 }
    };

    // Datos dummy
    function generateData() {
      const data = [];
      const seed = 1234567;
      let s = seed;
      const rand = () => {
        s = (1664525 * s + 1013904223) >>> 0;
        return s / 2**32;
      };

      for(let i=0; i<config.n; i++) {
        const x = config.xDomain[0] + (config.xDomain[1] - config.xDomain[0]) * rand();
        const trend = (x - config.xDomain[0]) / (config.xDomain[1] - config.xDomain[0]);
        let y = -1.2 + 2.6 * trend + (rand() - 0.5) * 0.9;
        y = Math.max(config.yDomain[0], Math.min(config.yDomain[1], y));
        data.push({ x, y });
      }
      return data;
    }

    const data = generateData();
    const focusPoint = { x: 4.5, y: 1.1 }; // Punto donde se ancla el tooltip

    function render() {
      const container = d3.select("#scatter-container");
      const svg = d3.select("#scatter-svg");
      const width = container.node().clientWidth;
      const height = 400;

      svg.selectAll("*").remove();

      const innerW = width - config.margin.left - config.margin.right;
      const innerH = height - config.margin.top - config.margin.bottom;

      const g = svg.append("g")
        .attr("transform", `translate(${config.margin.left},${config.margin.top})`);

      const x = d3.scaleLinear().domain(config.xDomain).range([0, innerW]);
      const y = d3.scaleLinear().domain(config.yDomain).range([innerH, 0]);

      // Grid
      g.append("g").attr("class", "scatter-grid")
        .call(d3.axisLeft(y).ticks(6).tickSize(-innerW).tickFormat(""));
      g.append("g").attr("class", "scatter-grid")
        .attr("transform", `translate(0,${innerH})`)
        .call(d3.axisBottom(x).ticks(10).tickSize(-innerH).tickFormat(""));

      // Ejes
      g.append("g").attr("class", "scatter-axis").call(d3.axisLeft(y).ticks(6));
      g.append("g").attr("class", "scatter-axis")
        .attr("transform", `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(10));

      // Threshold
      const yT = y(config.thresholdY);
      g.append("line").attr("class", "scatter-threshold")
        .attr("x1", 0).attr("x2", innerW).attr("y1", yT).attr("y2", yT);

      // Puntos
      const pRadius = document.getElementById("in-p-radius").value;
      g.selectAll(".scatter-point")
        .data(data)
        .enter()
        .append("circle")
        .attr("class", "scatter-point")
        .attr("r", pRadius)
        .attr("cx", d => x(d.x))
        .attr("cy", d => y(d.y));

      // Punto de foco (naranja)
      g.append("circle")
        .attr("class", "scatter-point")
        .attr("r", pRadius)
        .attr("cx", x(focusPoint.x))
        .attr("cy", y(focusPoint.y))
        .style("opacity", 1);

      // Posicionar Tooltip
      updateTooltipPos(x, y, width);
    }

    function updateTooltipPos(xScale, yScale, containerWidth) {
      const tip = document.getElementById("scatter-tip");
      const offsetX = parseInt(document.getElementById("in-offset-x").value);

      const px = config.margin.left + xScale(focusPoint.x);
      const py = config.margin.top + yScale(focusPoint.y);

      const flipLeft = px > containerWidth * 0.8;
      const tx = flipLeft ? px - offsetX : px + offsetX;

      tip.style.left = tx + "px";
      tip.style.top = py + "px";

      if (flipLeft) tip.classList.add("flip-left");
      else tip.classList.remove("flip-left");
    }

    function updateStyles() {
      const root = document.documentElement;
      const vals = {
        font: document.getElementById("in-font").value,
        padY: document.getElementById("in-pad-y").value,
        padX: document.getElementById("in-pad-x").value,
        minW: document.getElementById("in-min-w").value,
        circle: document.getElementById("in-circle").value,
        dot: document.getElementById("in-dot").value,
        arrowH: document.getElementById("in-arrow-h").value,
        arrowW: document.getElementById("in-arrow-w").value,
        offsetX: document.getElementById("in-offset-x").value,
        circleOff: document.getElementById("in-circle-off").value,
        text: document.getElementById("in-text").value,
        pRadius: document.getElementById("in-p-radius").value
      };

      root.style.setProperty("--tip-font-size", vals.font + "px");
      root.style.setProperty("--tip-padding-y", vals.padY + "px");
      root.style.setProperty("--tip-padding-x", vals.padX + "px");
      root.style.setProperty("--tip-min-width", vals.minW + "px");
      root.style.setProperty("--tip-circle-size", vals.circle + "px");
      root.style.setProperty("--tip-dot-size", vals.dot + "px");
      root.style.setProperty("--tip-arrow-height", vals.arrowH + "px");
      root.style.setProperty("--tip-arrow-width", vals.arrowW + "px");
      root.style.setProperty("--tip-circle-offset", vals.circleOff + "px");

      document.getElementById("tip-text-el").textContent = vals.text;

      // Actualizar etiquetas de valor
      document.getElementById("val-text").textContent = vals.text;
      document.getElementById("val-font").textContent = vals.font + "px";
      document.getElementById("val-pad-y").textContent = vals.padY + "px";
      document.getElementById("val-pad-x").textContent = vals.padX + "px";
      document.getElementById("val-min-w").textContent = vals.minW + "px";
      document.getElementById("val-circle").textContent = vals.circle + "px";
      document.getElementById("val-dot").textContent = vals.dot + "px";
      document.getElementById("val-offset-x").textContent = vals.offsetX + "px";
      document.getElementById("val-circle-off").textContent = vals.circleOff + "px";
      document.getElementById("val-arrow").textContent = vals.arrowH + "/" + vals.arrowW;
      document.getElementById("val-p-radius").textContent = vals.pRadius + "px";

      render();
      generateCode(vals);
    }

    function generateCode(v) {
      const css = `.scatter-tip-inner {
  font-size: ${v.font}px;
  padding: ${v.padY}px ${v.padX}px;
  min-width: ${v.minW}px;
  font-weight: 800;
  border-radius: 12px;
  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.scatter-tip-inner::before {
  left: -${v.arrowW}px;
  border-top: ${v.arrowH}px solid transparent;
  border-bottom: ${v.arrowH}px solid transparent;
  border-right: ${v.arrowW}px solid #ffffff;
}

.scatter-tip-dot {
  left: ${v.circleOff}px;
  width: ${v.circle}px;
  height: ${v.circle}px;
  background: #ffffff;
  border-radius: 50%;
  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
}

.scatter-tip-dot::after {
  width: ${v.dot}px;
  height: ${v.dot}px;
  background: #ff8c1a;
  border-radius: 50%;
}

/* Configuración JS */
const scatterConfig = {
  pointRadius: ${v.pRadius},
  tooltipOffsetX: ${v.offsetX},
  flipThreshold: 0.20
};`;
      document.getElementById("code-css").textContent = css;
    }

    // Listeners
    const inputs = document.querySelectorAll("input");
    inputs.forEach(i => i.addEventListener("input", updateStyles));

    document.getElementById("copy-css").addEventListener("click", () => {
      const code = document.getElementById("code-css").textContent;
      navigator.clipboard.writeText(code);
      const btn = document.getElementById("copy-css");
      btn.textContent = "¡Copiado!";
      setTimeout(() => btn.textContent = "Copiar CSS", 2000);
    });

    window.addEventListener("resize", render);

    // Init
    updateStyles();
  </script>
</body>
</html>